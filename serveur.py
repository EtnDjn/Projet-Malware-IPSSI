import socket

# Fonction pour réceptionner les données d'un client
def recv_data(conn):
    data_size = ""
    data_content = b""  # Pour les données binaires

    # Lecture de la taille
    ch = conn.recv(1).decode()
    while ch != "#":
        data_size += ch
        ch = conn.recv(1).decode()
    
    # Lecture du contenu
    for i in range(int(data_size)):
        data_content += conn.recv(1)

    return data_content

def send_data(conn, data):
    conn.sendall(data.encode())

# Socket serveur d'écoute
with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
    s.bind(("127.0.0.1", 12347))
    s.listen()
    print("Waiting for client...")
    conn, addr = s.accept()
    #Logique principale après connexion à un client
    with conn:
        print("Connection received from:", addr)
        #Reception du menu
        data_content = recv_data(conn)
        print(data_content.decode())
        
        #Boucle infinie pour que la communication ne s'arrête que si elle reçoit QUIT
        while True:
            #Logique pour envoyer une commande
            command = input("Command ? :")
            if command.upper() == "QUIT" :
                send_data(conn, command)
                print("End of connection")
                break
            else :
                send_data(conn, command)

            #Logique selon la réponse du client
            data_content = recv_data(conn)
            print("Received:", data_content.decode())

import socket

# Fonction pour réceptionner les données d'un client
def recv_data(conn):
    data_size = ""
    data_tag = ""
    data_content = b""  # Pour les données binaires

    # Lecture de la taille
    ch = conn.recv(1).decode()
    while ch != "#":
        data_size += ch
        ch = conn.recv(1).decode()

    # Lecture du tag
    ch = conn.recv(1).decode()
    while ch != "#":
        data_tag += ch
        ch = conn.recv(1).decode()
    
    # Lecture du contenu
    for i in range(int(data_size)):
        data_content += conn.recv(1)

    return data_tag, data_content

def send_data(conn, data):
    conn.sendall(data.encode())

# Fonction pour écrire le téléchargement dans un fichier
def write_to_file(filename, content):
    try:
        with open(filename + "_copy", 'wb') as f:
            f.write(content)
        print(f"File '{filename}' has been successfully written.")
    except Exception as e:
        print(f"Error writing to file '{filename}': {e}")


# Socket serveur d'écoute
with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
    s.bind(("127.0.0.1", 12347))
    s.listen()
    print("Waiting for client...")
    conn, addr = s.accept()
    #Logique principale après connexion à un client
    with conn:
        print("Connection received from:", addr)
        #Reception du menu
        data_content = recv_data(conn)
        print(data_content)
        
        #Boucle infinie pour que la communication ne s'arrête que si elle reçoit QUIT
        while True:
            #Logique pour envoyer une commande
            command = input("Command ? :")
            if command.upper() == "QUIT" :
                send_data(conn, command)
                print("End of connection")
                break
            else :
                send_data(conn, command)

            #Logique selon la réponse du client
            data_tag, data_content = recv_data(conn)

            if data_tag == "REP":
                print(data_content)
            elif data_tag == "DLR":
                filename = "test"
                write_to_file(filename, data_content)
                
            else:
                print("Received:", data_content.decode())
